<div class="container">
  <h2 class="h4">Ejecución de recepción de productos</h2>

  <div class="mb-3">
    <label class="form-label me-2">Fecha:</label>
    <input class="form-control d-inline-block" style="max-width: 16rem;" type="date" [(ngModel)]="fecha" (ngModelChange)="onFechaChange()">
  </div>

  <div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Proveedor</th>
        <th>Estado</th>
        <th>Jaula</th>
        <th>Recepción</th>
        <th class="text-end">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let t of lista">
        <tr>
          <td>{{ t.horaInicioAgendamiento }}</td>
          <td>{{ t.horaFinAgendamiento }}</td>
          <td>{{ mapProveedores[t.idProveedor].nombre || '-' }}</td>
          <td>{{ getEstado(t) }}</td>
          <td>{{ t.idJaula ? mapJaulas[t.idJaula]?.nombre : '-' }}</td>
          <td>
            {{ t.horaInicioRecepcion || '-' }} - {{ t.horaFinRecepcion || '-' }}
          </td>
          <td class="text-end">
            <div class="d-inline-flex align-items-center gap-2">
              <button class="btn btn-sm btn-outline-info" (click)="alternarDetalles(t.idTurno)">Detalles</button>
              <ng-container *ngIf="!t.horaInicioRecepcion">
                <select class="form-select form-select-sm d-inline-block" style="width: auto; min-width: 12rem;" [(ngModel)]="jaulaSeleccionada[t.idTurno]">
                  <option [ngValue]="null">-- Jaula libre --</option>
                  <option *ngFor="let j of jaulasDisponibles" [ngValue]="j.idJaula">{{ j.nombre }} ({{ j.idJaula }})</option>
                </select>
                <button class="btn btn-sm btn-success" (click)="iniciar(t)">Iniciar recepción</button>
              </ng-container>
              <button class="btn btn-sm btn-warning" *ngIf="t.horaInicioRecepcion && !t.horaFinRecepcion" (click)="finalizar(t)">Finalizar recepción</button>
            </div>
          </td>
        </tr>
        <tr *ngIf="mostrarDetalles[t.idTurno]">
          <td colspan="7">
            <table class="table table-bordered table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th>Cantidad</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let d of t.detalles">
                  <td>{{ mapProductos[d.idProducto].nombre || d.idProducto }}</td>
                  <td>{{ d.cantidad }}</td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
  </div>
</div>
